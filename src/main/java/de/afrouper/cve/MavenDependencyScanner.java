package de.afrouper.cve;

import de.afrouper.zip.ZipElement;
import de.afrouper.zip.ZipFileVisitor;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;

public class MavenDependencyScanner {

    private static final String JNDI_LOOKUP_CLASS = "/org/apache/commons/text/StringSubstitutor.class";
    private static final String LOG4J2_POM = "META-INF/maven/org.apache.commons/commons-text/pom.properties";

    private final String clazzToCheck;

    private final MavenCoordinates fixedVersion;

    private final ZipFileVisitor zipFileVisitor;

    private final Map<String, ScanResult> findings;

    public MavenDependencyScanner(File rootDir, MavenCoordinates fixedVersion, String clazzToCheck) {
        zipFileVisitor = new ZipFileVisitor(rootDir);
        findings = new HashMap<>();
        this.clazzToCheck = clazzToCheck;
        this.fixedVersion = fixedVersion;
    }

    public void scan() throws IOException {
        zipFileVisitor.scan(this::handleMavenPom, this::isZip);
    }

    public Map<String, ScanResult> getFindings() {
        return findings;
    }

    private void handleMavenPom(ZipElement zipElement) {
        try {
            String name = zipElement.getZipEntry().getName();
            if(name != null && name.startsWith("META-INF/maven/") && name.endsWith("pom.properties")) {
                MavenCoordinates coordinates = readMavenCoordinates(zipElement.getZipEntryInputStream());
                if(fixedVersion.equalGroupAndArtifactIds(coordinates)) {
                    ScanResult scanResult = getScanResult(createPath(zipElement.getFilePath()));
                    scanResult.setMavenCoordinates(coordinates);
                    if (isVulnerable(coordinates)) {
                        scanResult.setVulnerable(true);
                    } else {
                        scanResult.setVulnerable(false);
                    }
                }
            }

            if (zipElement.getZipEntry().getName().endsWith(JNDI_LOOKUP_CLASS)) {
                ScanResult scanResult = getScanResult(createPath(zipElement.getFilePath()));
                scanResult.setPotentiallyVulnerable(true);
            }
        } catch (IOException e) {
            System.err.println("Unable to process ZIP element " + zipElement + ": " + e.getMessage());
        }
    }

    private ScanResult getScanResult(String key) {
        ScanResult scanResult = findings.get(key);
        if (scanResult == null) {
            scanResult = new ScanResult();
            findings.put(key, scanResult);
        }
        return scanResult;
    }

    private boolean isVulnerable(MavenCoordinates coordinates) {
        ComparableVersion version = coordinates.getVersion();
        return fixedVersion.getVersion().compareTo(version) >= 0;
    }

    private String createPath(List<String> path) {
        return String.join(" -> ", path);
    }

    private MavenCoordinates readMavenCoordinates(InputStream zipEntryInputStream) throws IOException {
        Properties props = new Properties();
        props.load(zipEntryInputStream);

        return new MavenCoordinates(props.getProperty("groupId"), props.getProperty("artifactId"), new ComparableVersion(props.getProperty("version")));
    }

    private Boolean isZip(String name) {
        String lowerCase = name.toLowerCase();
        return lowerCase.endsWith(".jar")
                || lowerCase.endsWith(".war")
                || lowerCase.endsWith(".ear")
                || lowerCase.endsWith(".zip");
    }
}
