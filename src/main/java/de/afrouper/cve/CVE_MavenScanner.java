package de.afrouper.cve;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class CVE_MavenScanner {

    static final Map<String, CVE_Bundle> CVE_BUNDLE_MAP;
    static {
        CVE_BUNDLE_MAP = new HashMap<>();
        initCVE_Bundles();
    }

    public static void main(String[] args) throws IOException {
        if (args == null || args.length != 1) {
            System.out.println("Usage: You have to specify a directory.");
            return;
        }
        File path = new File(args[0]);

        String cve = "CVE-2022-42889";
        CVE_Bundle cveBundle = CVE_BUNDLE_MAP.get(cve);
        if(cveBundle == null) {
            System.out.println("Usage: You have to specify a CVE number; e.g. 'CVE-2022-42889'.");
            return;
        }

        MavenDependencyScanner scanner = new MavenDependencyScanner(path, cveBundle.getFixedVersion(), cveBundle.getClazzToCheck());
        scanner.scan();
        Map<String, ScanResult> findings = scanner.getFindings();

        if (findings.isEmpty()) {
            System.out.println("No Findings!");
            System.exit(0);
        }
        findings.forEach((key, scanResult) -> scanResult.isVulnerable().ifPresent(vulnerable -> {
            if (vulnerable) {
                System.out.println("[*] \uD83D\uDD25 " + scanResult.getMavenCoordinates() + " in " + key);
            }
        }));
        System.exit(1);
    }

    private static void initCVE_Bundles() {
        CVE_BUNDLE_MAP.put("CVE-2022-42889", new CVE_Bundle(
                new MavenCoordinates("org.apache.commons", "commons-text", new ComparableVersion("1.10")),
                "org/apache/commons/text/StringSubstitutor.class"));

        CVE_Bundle log4Shell = new CVE_Bundle(new MavenCoordinates("org.apache.logging.log4j", "log4j-core", new ComparableVersion("2.17.1")),
                "/log4j/core/lookup/JndiLookup.class");

        CVE_BUNDLE_MAP.put("CVE-2021-44228", log4Shell);
        CVE_BUNDLE_MAP.put("CVE-2021-45046", log4Shell);
        CVE_BUNDLE_MAP.put("CVE-2021-45105", log4Shell);
    }
}
